<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flight Seats - Flight Reservation System</title>
    <link rel="stylesheet" href="/styles.css" />
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .flight-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            border-left: 4px solid #667eea;
        }
        
        .flight-info h2 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .flight-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .detail-item {
            display: flex;
            flex-direction: column;
        }
        
        .detail-label {
            font-weight: 600;
            color: #666;
            font-size: 14px;
        }
        
        .detail-value {
            color: #333;
            font-size: 16px;
        }
        
        .seat-map-container {
            margin-bottom: 30px;
        }
        
        .seat-map-title {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
        }
        
        .seat-map {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        
        .seat-row {
            display: flex;
            gap: 5px;
            align-items: center;
        }
        
        .row-number {
            width: 30px;
            text-align: center;
            font-weight: 600;
            color: #666;
        }
        
        .seat {
            width: 40px;
            height: 40px;
            border: 2px solid #ddd;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .seat.available {
            background-color: #4CAF50;
            border-color: #4CAF50;
            color: white;
        }
        
        .seat.available:hover {
            background-color: #45a049;
            transform: scale(1.1);
        }
        
        .seat.reserved {
            background-color: #FF9800;
            border-color: #FF9800;
            color: white;
            cursor: not-allowed;
        }
        
        .seat.booked {
            background-color: #f44336;
            border-color: #f44336;
            color: white;
            cursor: not-allowed;
        }
        
        .seat.empty {
            background-color: #f8f9fa;
            border-color: #e9ecef;
            cursor: default;
        }
        
        .seat.first-class {
            border-color: #6f42c1;
        }
        
        .seat.business-class {
            border-color: #fd7e14;
        }
        
        .seat.economy-class {
            border-color: #28a745;
        }
        
        .seat-legend {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 2px solid #ddd;
        }
        
        .legend-color.available { background-color: #d4edda; border-color: #c3e6cb; }
        .legend-color.reserved { background-color: #fff3cd; border-color: #ffeaa7; }
        .legend-color.booked { background-color: #f8d7da; border-color: #f5c6cb; }
        
        /* New grid layout styles */
        .seat-classes-container {
            margin-bottom: 30px;
        }
        
        .seat-class-section {
            margin-bottom: 40px;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #dee2e6;
        }
        
        .seats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 8px;
            margin-bottom: 20px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        
        .class-summary {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 15px;
            padding: 15px;
            background: #e9ecef;
            border-radius: 8px;
            font-weight: bold;
            color: #333;
        }
        
        .class-summary span {
            padding: 5px 10px;
            background: white;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }
        
        .seat-info {
            position: absolute;
            bottom: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .seat:hover .seat-info {
            opacity: 1;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        
        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #e9ecef;
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
        
        .nav-links {
            text-align: center;
            margin-top: 30px;
        }
        
        .nav-link {
            color: #667eea;
            text-decoration: none;
            margin: 0 15px;
            padding: 10px 20px;
            border: 2px solid #667eea;
            border-radius: 25px;
            transition: all 0.3s ease;
        }
        
        .nav-link:hover {
            background-color: #667eea;
            color: white;
        }
        
        .loading {
            display: none;
            text-align: center;
            color: #666;
        }
    </style>
</head>
<body>
    <nav class="navbar" th:replace="~{home :: .navbar}"></nav>
    <div class="container">
        <div class="flight-info">
            <h2 th:text="${flight.origin + ' â†’ ' + flight.destination}">Flight Route</h2>
            <div th:if="${selectedSeatClass != null}" class="selected-class-info" style="background: #e3f2fd; padding: 10px; border-radius: 5px; margin: 10px 0; border-left: 4px solid #2196f3;">
                <strong>Selected Class:</strong> <span th:text="${selectedSeatClass}">ECONOMY</span>
            </div>
            <div class="flight-details">
                <div class="detail-item">
                    <span class="detail-label">Departure</span>
                    <span class="detail-value" th:text="${#temporals.format(flight.departureTime, 'dd/MM/yyyy HH:mm')}">01/01/2024 10:00</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Arrival</span>
                    <span class="detail-value" th:text="${#temporals.format(flight.arrivalTime, 'dd/MM/yyyy HH:mm')}">01/01/2024 12:00</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Aircraft</span>
                    <span class="detail-value" th:text="${flight.airplane.manufacturer + ' ' + flight.airplane.model}">Boeing 737</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Registration</span>
                    <span class="detail-value" th:text="${flight.airplane.registrationNumber}">N123AB</span>
                </div>
            </div>
        </div>

        <div th:if="${seatsByClass != null and !seatsByClass.isEmpty()}" class="seat-classes-container">
            <div th:each="seatClassEntry : ${seatsByClass}" 
                 th:if="${selectedSeatClass == null or seatClassEntry.key.name() == selectedSeatClass}" 
                 class="seat-class-section">
                <div class="class-header">
                    <h3 class="class-title" th:text="${seatClassEntry.key.name() + ' Class'}">First Class</h3>
                    <p class="class-subtitle">Choose your preferred seat</p>
                </div>
                
                <div th:each="rowEntry : ${seatsByClassRows[seatClassEntry.key]}" style="margin-bottom:8px;">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <div class="row-number" th:text="${rowEntry.key}">1</div>
                        <div class="seats-grid" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap:8px; flex:1;">
                            <div th:each="flightSeat : ${rowEntry.value}"
                                 th:class="'seat ' + ${flightSeat.status.name().toLowerCase()}"
                                 th:data-seat-id="${flightSeat.id}"
                                 th:data-seat-number="${flightSeat.seat.seatNumber}"
                                 th:data-status="${flightSeat.status.name()}"
                                 th:text="${flightSeat.seat.seatNumber}">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="class-summary">
                    <span th:text="'Total seats: ' + ${#lists.size(seatClassEntry.value)}">Total seats: 20</span>
                    <span th:text="'Available: ' + ${#lists.size(seatClassEntry.value.?[status.name() == 'AVAILABLE'])}">Available: 15</span>
                    <span th:text="'Reserved: ' + ${#lists.size(seatClassEntry.value.?[status.name() == 'RESERVED'])}">Reserved: 3</span>
                    <span th:text="'Booked: ' + ${#lists.size(seatClassEntry.value.?[status.name() == 'BOOKED'])}">Booked: 2</span>
                </div>
            </div>
        </div>

        <div class="seat-legend">
            <div class="legend-item">
                <div class="legend-color available"></div>
                <span>Available</span>
            </div>
            <div class="legend-item">
                <div class="legend-color reserved"></div>
                <span>Reserved (5 min)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color booked"></div>
                <span>Booked</span>
            </div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" th:text="${#lists.size(availableSeats)}">0</div>
                <div class="stat-label">Available</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" th:text="${#lists.size(reservedSeats)}">0</div>
                <div class="stat-label">Reserved</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" th:text="${#lists.size(bookedSeats)}">0</div>
                <div class="stat-label">Booked</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" th:text="${#lists.size(allSeats)}">0</div>
                <div class="stat-label">Total</div>
            </div>
        </div>

        <div class="nav-links">
            <a href="/" class="nav-link">Home</a>
            <a th:if="${hasWizard}"
               th:href="@{'/reservations/next'}"
               th:text="${hasNextSegment} ? 'Next Segment' : 'Finish Booking'"
               class="nav-link"></a>
        </div>
    </div>

    <script>
        const seats = /*[[${allSeats}]]*/ [];
        const flightId = /*[[${flight.id}]]*/ 0;
        const hasWizard = /*[[${hasWizard}]]*/ false;
        const hasNextSegment = /*[[${hasNextSegment}]]*/ false;
        
        function generateSeatMap() {
            const seatMap = document.getElementById('seatMap');
            seatMap.innerHTML = '';

            const seatsByRow = {};
            seats.forEach(seat => {
                const seatNumber = seat.seatNumber;
                const rowNumber = seatNumber.match(/\d+/)[0];
                if (!seatsByRow[rowNumber]) {
                    seatsByRow[rowNumber] = [];
                }
                seatsByRow[rowNumber].push(seat);
            });

            const sortedRows = Object.keys(seatsByRow).sort((a, b) => parseInt(a) - parseInt(b));
            
            sortedRows.forEach(rowNumber => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'seat-row';
                
                const rowLabel = document.createElement('div');
                rowLabel.className = 'row-number';
                rowLabel.textContent = rowNumber;
                rowDiv.appendChild(rowLabel);

                const rowSeats = seatsByRow[rowNumber].sort((a, b) => 
                    a.seatNumber.localeCompare(b.seatNumber, undefined, {numeric: true})
                );
                
                rowSeats.forEach(seat => {
                    const seatDiv = document.createElement('div');
                    seatDiv.className = `seat ${seat.status.toLowerCase().replace('_', '-')} ${seat.seat.seatClass.toLowerCase().replace('_', '-')}`;
                    seatDiv.textContent = seat.seatNumber.replace(/\d+/, '');
                    seatDiv.dataset.seatId = seat.id;
                    seatDiv.dataset.status = seat.status;

                    const seatInfo = document.createElement('div');
                    seatInfo.className = 'seat-info';
                    seatInfo.textContent = `${seat.seatNumber} - ${seat.seat.seatClass} - $${seat.price}`;
                    seatDiv.appendChild(seatInfo);

                    if (seat.status === 'AVAILABLE') {
                        seatDiv.addEventListener('click', () => reserveSeat(seat.id));
                    }
                    
                    rowDiv.appendChild(seatDiv);
                });
                
                seatMap.appendChild(rowDiv);
            });
        }
        
        function getCsrf(){
            var token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            var header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
            var h = {}; h[header] = token; return h;
        }

        function reserveSeat(seatId) {
            const seatElement = document.querySelector(`[data-seat-id="${seatId}"]`);
            if (!seatElement || seatElement.dataset.status !== 'AVAILABLE') return;
            
            fetch(`/reservations/reserve/${seatId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    ...getCsrf()
                }
            })
            .then(response => response.text())
            .then(result => {
                if (result === 'SUCCESS') {
                    seatElement.className = seatElement.className.replace('available', 'reserved');
                    seatElement.dataset.status = 'RESERVED';
                    seatElement.removeEventListener('click', () => reserveSeat(seatId));

                    const confirmBtn = document.createElement('button');
                    confirmBtn.textContent = 'Confirm';
                    confirmBtn.style.cssText = 'position: absolute; top: -30px; left: 50%; transform: translateX(-50%); background: #28a745; color: white; border: none; padding: 2px 8px; border-radius: 3px; font-size: 10px; cursor: pointer;';
                    confirmBtn.onclick = (e) => {
                        e.stopPropagation();
                        confirmReservation(seatId);
                    };
                    
                    const cancelBtn = document.createElement('button');
                    cancelBtn.textContent = 'Cancel';
                    cancelBtn.style.cssText = 'position: absolute; top: -30px; left: 50%; transform: translateX(-50%); background: #dc3545; color: white; border: none; padding: 2px 8px; border-radius: 3px; font-size: 10px; cursor: pointer; margin-left: 30px;';
                    cancelBtn.onclick = (e) => {
                        e.stopPropagation();
                        cancelReservation(seatId);
                    };
                    
                    seatElement.appendChild(confirmBtn);
                    seatElement.appendChild(cancelBtn);

                    setTimeout(() => {
                        location.reload();
                    }, 300000); // 5 minutes
                } else {
                    alert('Failed to reserve seat. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            });
        }
        
        function confirmReservation(seatId) {
            fetch(`/reservations/confirm/${seatId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    ...getCsrf()
                }
            })
            .then(response => response.text())
            .then(result => {
                if (result === 'SUCCESS') {
                    if (hasWizard) {
                        window.location.href = '/reservations/next';
                    } else {
                        location.reload();
                    }
                } else {
                    alert('Failed to confirm reservation. Please try again.');
                }
            });
        }
        
        function cancelReservation(seatId) {
            fetch(`/reservations/cancel/${seatId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    ...getCsrf()
                }
            })
            .then(response => response.text())
            .then(result => {
                if (result === 'SUCCESS') {
                    location.reload();
                } else {
                    alert('Failed to cancel reservation. Please try again.');
                }
            });
        }

        document.addEventListener('DOMContentLoaded', function(){
            var seatDivs = document.querySelectorAll('.seats-grid .seat');
            for (var i = 0; i < seatDivs.length; i++) {
                (function(el){
                    if (el.dataset && el.dataset.status === 'AVAILABLE') {
                        el.addEventListener('click', function(){
                            var id = el.getAttribute('data-seat-id');
                            reserveSeat(id);
                        });
                    }
                })(seatDivs[i]);
            }
        });
    </script>
</body>
</html>
